<!DOCTYPE html>
<html lang="en">
<head>
    <title>EduWIne</title>
      <link rel="stylesheet" type="text/css" href="css/global.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">
	 //function to parse our response
	 const parseJSON = (xhr, content) => {
      //parse response (obj will be empty in a 204 updated)
      const obj = JSON.parse(xhr.response);
     // console.dir(obj);
      //console.log(xhr.response);

      //if message in response, add to screen
      if(obj.message) {
        const p = document.createElement('p');
        p.textContent = `Message: ${obj.message}`;
        content.appendChild(p);
      }
      
      //Display catalog
      if(obj.Products)
      {

	     for(const item in obj.Products.List)
	      {
		    const p = document.createElement('p');
		    p.setAttribute("class", "wino");
		    
			p.textContent += obj.Products.List[item].Name;
			p.textContent += "Vintage: " + obj.Products.List[item].Vintage;
			
			
			const inp = document.createElement("INPUT");
			//console.log(item);
			inp.setAttribute("type", "button");
			inp.setAttribute("class", "btn" + item);
			inp.setAttribute("value", "Details");
			content.appendChild(inp);
			content.appendChild(p);
			const userForm = document.querySelector('.btn'+item);
			const getUser = (e) => getDetails(e, userForm);
			userForm.addEventListener('button', getUser);
		   }
		 }
	};
    

   //function to handle our response
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');
      
      console.log(xhr.status);

      
      //check the status code 
      //200, 201, 304, 404
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>200: Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>201: User Created</b>';
          break;
        case 304:
		content.innerHTML = '<b>Not Modified</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404: //if not found
        content.innerHTML = `<b>Resource Not Found</b>`;
        break;
        default: //any other status code
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }

      //parse response 
      //parseJSON(xhr, content);

      if(parseResponse || xhr.status == '201' || xhr.status == '400') {
        parseJSON(xhr, content);
       //console.log(xhr.response);
      } else {
        console.log('received');
      }

    };

	const viewCat = () => {
		const method = 'get';

      const xhr = new XMLHttpRequest();
      xhr.open(method, '/cat');
      xhr.setRequestHeader ('Accept', 'application/json');
     
    if(method == 'get') {
        //set onload to parse request and get json message
        xhr.onload = () => handleResponse(xhr, true);
      } else {
        
        xhr.onload = () => handleResponse(xhr, false);
      }
     
      xhr.send();
      //e.preventDefault();
      return false;

	};
	
	const getDetails = (e, bttn) => {
		console.log("Get detials");
		//Check status & dynamically add elements
		
		/*for(const vin in obj.Products.List[item].Vineyard)
			{
			p.textContent += "Vineyard Name: " + obj.Products.List[item].Vineyard.Name;
			//p.textContent += Ëœ*/
			
			//p.textContent += " PriceRetail: $" + obj.Products.List[item].PriceRetail;

	};

    const init = () =>{
		viewCat();		
    };
    
   window.onload = init;

    </script>
</head>
<body>
    <h1>EduWine</h1>
    <div id="content">
	    
    </div>
    
</body>
</html>